<!DOCTYPE html>
<html lang="en">
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" type="text/css" href="runcompare.css">
<title>runcompare</title>

<script
src="https://www.gstatic.com/charts/loader.js">
</script>

<script>

var json;
var data;
var eventMin = 1000;
var eventMax = 0;

async function body() {
    console.log("body()");

    google.charts.load('current',{packages:['corechart']});

    json = await getText();
    for (const runner of json.runners) {
        console.log("+-> " + runner.name);
		for (const run of runner.events) {
				if (Number(run.event) < eventMin) eventMin = Number(run.event);
				if (Number(run.event) > eventMax) eventMax = Number(run.event);
			}
    }
	console.log("Range " + eventMin + "-" + eventMax);

    select1 = document.getElementById("selectRunner1");
    select2 = document.getElementById("selectRunner2");
	select2.disabled = true;
    select3 = document.getElementById("selectRunner3");
	select3.disabled = true;
    select4 = document.getElementById("selectRunner4");
	select4.disabled = true;
    for (const element of json.runners) {
        select1.appendChild(new Option(element.name, element.id));
        select2.appendChild(new Option(element.name, element.id));
        select3.appendChild(new Option(element.name, element.id));
        select4.appendChild(new Option(element.name, element.id));
    }

}

async function getText() {
    console.log("Getting json");
    //myObject = await fetch("https://petesndrs.github.io/runcompare/RunnerData.json");
    myObject = await fetch("./RunnerData.json");
    myText = await myObject.text();
    console.log(myText);
    const json = JSON.parse(myText);
    return json;
}

function selectRunner1() {
    selectRunner(1);
	document.getElementById("selectRunner2").disabled=false;
}

function selectRunner2() {
    selectRunner(2);
	document.getElementById("selectRunner3").disabled=false;
}

function selectRunner3() {
    selectRunner(3);
	document.getElementById("selectRunner4").disabled=false;
}

function selectRunner4() {
    selectRunner(4);
}

function selectRunner(i) {
    selected = document.getElementById("selectRunner"+i).value;
    console.log(selected);
    for (const element of json.runners) {
        if (element.id == selected) {
            console.log("found...");
			for (const run of element.events) {
				console.log(run.time + " " + run.event);
			}
			drawVisualization(i, element.name, element.events);
        }
    }

}

const columns = [];

function drawVisualization(i, name, events) {

  console.log(data);
  
  if (typeof data == "undefined") {
    console.log("new DataTable");
    data = new google.visualization.DataTable();
    data.addColumn('number', 'Event');
	for (ev = eventMax; ev >= eventMin; ev--){
		data.addRows([[ev]]);
	}
	console.log("Number of rows " + data.getNumberOfRows());
  }
  
  console.log(columns);
  if (typeof columns[i] !== "undefined" && columns[i] !== name) {
    console.log("Remove old column " + columns[i]);
    data.removeColumn(i);
  }
  
  columns[i] = name;
  console.log("Insert new column " + columns[i]);
  data.insertColumn(i, 'timeofday', name);

  for (const event of events) {
  if (typeof event.time !== "undefined"){
	t = String(event.time).split(":");
	//console.log(event.time + " " + event.event + " " + t);
	//console.log("SetValue ", eventMax - Number(event.event), i);
	if (t.length === 2) {
	  data.setValue(eventMax - Number(event.event),i,[0,Number(t[0]),Number(t[1])]);
	}
	if (t.length === 3) {
	  data.setValue(eventMax - Number(event.event),i,[Number(t[0]),Number(t[1]),Number(t[2])]);
	}
	}
  }

  var chart = new google.visualization.ScatterChart(document.getElementById('myChart'));

  var options = {
          hAxis: { title: 'Event number',
		           minValue: 60,
		           maxValue: 660,
                   gridlines: { minSpacing: 20}
				 },
		  vAxis: { title: 'Time',
		           format: 'H:mm:ss'
		         },
          pointSize: 5,
          series: {
                0: { pointShape: 'circle', color:'red'},
                1: { pointShape: 'triangle', color:'violet'},
                2: { pointShape: 'square', color:'lime'},
                3: { pointShape: 'diamond', color:'blue'}
            }
        };
  chart.draw(data, options);
}

</script>

</head>

<body onload="body()">

<h1>Compare the parkruns</h1>

<h2>Select Runners</h2>

<div style="border: 2px solid red;">
<select id="selectRunner1" onchange="selectRunner1()">
  <option style="display:none">Select Runner</option>
</select>
</div>

<div style="border: 2px solid violet;">
<select id="selectRunner2" onchange="selectRunner2()">
  <option style="display:none">Select Runner</option>
</select>
</div>

<div style="border: 2px solid lime;">
<select id="selectRunner3" onchange="selectRunner3()">
  <option style="display:none">Select Runner</option>
</select>
</div>

<div style="border: 2px solid blue;">
<select id="selectRunner4" onchange="selectRunner4()">
  <option style="display:none">Select Runner</option>
</select>
</div>

<div id="myChart" style="max-width:800px; height:400px"></div>

<p class="filler">&nbsp;</p>

<footer>
</footer>

</body>

</html>